<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Demo Replica — Eiffel Tower Check-In Automation</title>
  <meta name="description" content="Functional demo replica of an automated check-in system with guide routing, summit toggle, and ticket cost summary." />

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --accent: #7dd3fc;
      --accent2:#a78bfa;
      --ok:#86efac;
      --warn:#fde68a;
      --bad:#fca5a5;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --max: 1180px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.22), transparent 55%),
        radial-gradient(900px 700px at 90% 15%, rgba(167,139,250,.18), transparent 55%),
        radial-gradient(1200px 700px at 50% 92%, rgba(134,239,172,.10), transparent 55%),
        var(--bg);
      color: var(--text);
      line-height:1.5;
    }

    a{ color:inherit; }
    .wrap{ width: min(var(--max), calc(100% - 40px)); margin: 0 auto; }
    .nav{
      position: sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(11,18,32,.62);
      border-bottom:1px solid var(--line);
    }
    .nav-inner{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 14px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 6px rgba(125,211,252,.10);
    }
    .nav-links{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      color: var(--muted);
      font-size:14px;
    }
    .pill{
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      text-decoration:none;
    }
    .pill:hover{ border-color: rgba(125,211,252,.55); }

    header{ padding: 26px 0 8px; }
    h1{ margin:0 0 8px; font-size: clamp(22px, 3vw, 36px); letter-spacing:-.3px; }
    .sub{ margin:0; color: var(--muted); max-width: 85ch; }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:start;
      padding: 18px 0 24px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .pad{ padding: 18px; }
    .row{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap: wrap;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
    }
    .mini{
      width: 8px; height: 8px; border-radius: 999px;
      background: rgba(125,211,252,.95);
      box-shadow: 0 0 0 5px rgba(125,211,252,.08);
    }

    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; }
    button, .btn{
      appearance:none;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      font-weight: 700;
      font-size: 13px;
      cursor:pointer;
    }
    button:hover, .btn:hover{ border-color: rgba(255,255,255,.22); }
    button.primary{
      border-color: rgba(125,211,252,.55);
      background: linear-gradient(135deg, rgba(125,211,252,.18), rgba(167,139,250,.14));
    }
    button.danger{
      border-color: rgba(252,165,165,.55);
      background: rgba(252,165,165,.08);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .tabs{
      display:flex; flex-wrap:wrap; gap:10px;
      padding: 0 0 10px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 12px;
    }
    .tab{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(125,211,252,.55);
      background: rgba(125,211,252,.10);
    }

    .form{
      display:grid;
      grid-template-columns: 1.2fr .8fr .8fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .form{ grid-template-columns: 1fr; }
    }
    label{ display:block; font-size: 12px; color: var(--muted2); margin: 0 0 6px; font-weight: 700; }
    input, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    .hint{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 8px;
    }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: top;
      font-size: 12px;
    }
    th{
      text-align:left;
      color: rgba(255,255,255,.82);
      font-size: 12px;
      letter-spacing:.2px;
      background: rgba(255,255,255,.03);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover td{ background: rgba(255,255,255,.02); }
    .muted{ color: var(--muted2); }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip.ok{ border-color: rgba(134,239,172,.35); color: rgba(134,239,172,.95); background: rgba(134,239,172,.08); }
    .chip.warn{ border-color: rgba(253,230,138,.35); color: rgba(253,230,138,.95); background: rgba(253,230,138,.08); }
    .chip.bad{ border-color: rgba(252,165,165,.35); color: rgba(252,165,165,.95); background: rgba(252,165,165,.08); }

    .smallrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .right{ text-align:right; }
    .mono{ font-family: var(--mono); }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 900px){ .two{ grid-template-columns: 1fr; } }

    details{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
      margin-top: 12px;
    }
    details summary{
      cursor:pointer;
      font-weight: 800;
      color: rgba(255,255,255,.86);
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    .callout{
      border: 1px solid rgba(125,211,252,.28);
      background: rgba(125,211,252,.08);
      border-radius: 14px;
      padding: 12px;
      color: rgba(255,255,255,.85);
      font-size: 13px;
    }
    .footer{
      padding: 26px 0 44px;
      border-top: 1px solid var(--line);
      color: var(--muted2);
      font-size: 13px;
      margin-top: 18px;
    }
    .toast{
      position: fixed;
      bottom: 16px;
      right: 16px;
      max-width: 420px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      color: rgba(255,255,255,.90);
      font-size: 13px;
      display:none;
      z-index: 100;
    }
  </style>
</head>

<body>
  <div class="nav">
    <div class="wrap nav-inner">
      <div class="brand"><span class="dot"></span> Demo Replica — Check‑In Automation</div>
      <div class="nav-links">
        <a class="pill" href="#main">Main Check‑In</a>
        <a class="pill" href="#guides">Guide Sheets</a>
        <a class="pill" href="#summary">Summary & Cost</a>
        <a class="pill" href="#proof">Proof Notes</a>
      </div>
    </div>
  </div>

  <header class="wrap">
    <h1>Eiffel Tower Ticketing — Automated Check‑In (Functional Demo)</h1>
    <p class="sub">
      A runnable, self-contained demo that replicates the operational logic of a Google Apps Script check‑in system:
      guide routing, de‑duplication, summit open/closed toggle, and ticket cost calculation — using synthetic data only.
    </p>

    <div class="kpi">
      <span class="badge"><span class="mini"></span> Event‑driven updates</span>
      <span class="badge"><span class="mini"></span> De‑duplication safeguards</span>
      <span class="badge"><span class="mini"></span> Summit toggle reclassification</span>
      <span class="badge"><span class="mini"></span> Ticket cost computation</span>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section id="main" class="card pad">
        <div class="row">
          <div>
            <h2 style="margin:0 0 6px;">Main Check‑In</h2>
            <div class="muted" style="font-size:13px;">Add guests, mark status, assign guides. The system routes “Show” guests into guide tabs and recalculates summaries instantly.</div>
          </div>
          <div class="btnbar">
            <button class="primary" id="seedBtn">Seed synthetic data</button>
            <button id="exportBtn">Export JSON</button>
            <button id="importBtn">Import JSON</button>
            <button class="danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="form" aria-label="Add guest">
          <div>
            <label for="guestName">Guest name</label>
            <input id="guestName" placeholder="e.g., Ama Mensah" />
          </div>
          <div>
            <label for="status">Check‑in status</label>
            <select id="status">
              <option value="">—</option>
              <option value="Show">Show</option>
              <option value="No Show">No Show</option>
            </select>
          </div>
          <div>
            <label for="guide">Guide</label>
            <select id="guide"></select>
          </div>

          <div>
            <label for="level">ET level</label>
            <select id="level">
              <option value="Summit">Summit</option>
              <option value="Second Floor">Second Floor</option>
            </select>
            <div class="hint">The summary uses this to classify tickets (Summit vs Second Floor).</div>
          </div>

          <div>
            <label>Counts (auto totals)</label>
            <div class="two" style="margin-top:0;">
              <div>
                <input id="adult" type="number" min="0" step="1" value="1" />
                <div class="hint">Adults</div>
              </div>
              <div>
                <input id="youth" type="number" min="0" step="1" value="0" />
                <div class="hint">Youth</div>
              </div>
              <div>
                <input id="child" type="number" min="0" step="1" value="0" />
                <div class="hint">Children</div>
              </div>
              <div>
                <input id="infant" type="number" min="0" step="1" value="0" />
                <div class="hint">Infants</div>
              </div>
            </div>
          </div>

          <div>
            <label>Total pax</label>
            <input id="total" class="mono" disabled />
            <div class="hint">Computed as Adult + Youth + Child + Infant.</div>
          </div>

          <div>
            <label>&nbsp;</label>
            <button class="primary" id="addBtn">Add / Update guest</button>
            <div class="hint">Uses de‑dup key = (normalized guest name + guide).</div>
          </div>
        </div>

        <details>
          <summary>Pricing (edit ticket prices)</summary>
          <div class="hint">These prices are demo defaults. You can change them to match your operational assumptions.</div>
          <div class="two">
            <div class="card pad" style="box-shadow:none;">
              <h3 style="margin:0 0 8px;">Summit</h3>
              <div class="two">
                <div>
                  <label class="muted2">Adult</label>
                  <input id="p_summit_adult" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label class="muted2">Youth</label>
                  <input id="p_summit_youth" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label class="muted2">Child</label>
                  <input id="p_summit_child" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label class="muted2">Infant</label>
                  <input id="p_summit_infant" type="number" min="0" step="0.01" />
                </div>
              </div>
            </div>
            <div class="card pad" style="box-shadow:none;">
              <h3 style="margin:0 0 8px;">Second Floor</h3>
              <div class="two">
                <div>
                  <label class="muted2">Adult</label>
                  <input id="p_second_adult" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label class="muted2">Youth</label>
                  <input id="p_second_youth" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label class="muted2">Child</label>
                  <input id="p_second_child" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label class="muted2">Infant</label>
                  <input id="p_second_infant" type="number" min="0" step="0.01" />
                </div>
              </div>
            </div>
          </div>
          <div class="btnbar" style="margin-top:10px;">
            <button id="savePricesBtn" class="primary">Save prices</button>
          </div>
        </details>

        <h3 style="margin-top:18px;">Guest list (Main Check‑In)</h3>
        <div class="hint">Tip: click “Edit” to load a row into the form; “Delete” removes it. Only “Show” guests appear in guide sheets.</div>

        <div style="max-height:420px; overflow:auto; border-radius:14px; margin-top:10px;">
          <table id="mainTable" aria-label="Main Check-In table">
            <thead>
              <tr>
                <th>Guest</th>
                <th>Status</th>
                <th>ET Level</th>
                <th class="right">Adult</th>
                <th class="right">Youth</th>
                <th class="right">Child</th>
                <th class="right">Infant</th>
                <th class="right">Total</th>
                <th>Guide</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <aside class="card pad">
        <h2 style="margin:0 0 8px;">Operational controls</h2>

        <div class="callout" style="margin-top:10px;">
          <strong>Summit availability</strong>
          <div class="hint" style="margin-top:6px;color:rgba(255,255,255,.75)">
            When “Summit Closed,” all Summit guests are reclassified into “Second Floor” totals in the summary & cost views.
          </div>

          <div style="margin-top:10px;">
            <label for="summitStatus">Summit status</label>
            <select id="summitStatus">
              <option value="Summit Opened">Summit Opened</option>
              <option value="Summit Closed">Summit Closed</option>
            </select>
          </div>

          <div class="smallrow" style="margin-top:10px;">
            <span id="stateChip" class="chip ok">State: Summit Opened</span>
            <span class="chip mono" id="autosaveChip">Autosave: ON</span>
          </div>
        </div>

        <details open>
          <summary>Quick demo checklist</summary>
          <ul>
            <li>Click <span class="mono">Seed synthetic data</span>.</li>
            <li>Mark a guest as <span class="mono">Show</span> and assign a guide.</li>
            <li>Open <span class="mono">Guide Sheets</span> and confirm routing.</li>
            <li>Switch to <span class="mono">Summit Closed</span> and view summary changes.</li>
            <li>Export JSON as evidence (optional).</li>
          </ul>
        </details>

        <details>
          <summary>About this demo</summary>
          <p class="note">
            This is a non-Sheets implementation that mirrors the original Apps Script logic:
            event-driven updates, de-dup, guide routing, summit toggle, and cost calculations.
            All data is synthetic and stored locally in your browser (localStorage).
          </p>
        </details>
      </aside>
    </div>

    <section id="guides" class="card pad">
      <div class="row">
        <div>
          <h2 style="margin:0 0 6px;">Guide Sheets</h2>
          <div class="muted" style="font-size:13px;">Shows only guests with status “Show”. (Equivalent to per-guide sheets.)</div>
        </div>
      </div>

      <div class="tabs" id="guideTabs"></div>
      <div id="guideView"></div>
    </section>

    <section id="summary" class="card pad">
      <div class="row">
        <div>
          <h2 style="margin:0 0 6px;">Summary & Ticket Cost</h2>
          <div class="muted" style="font-size:13px;">Aggregates guests by Guide × Level × Age group, and applies ticket prices.</div>
        </div>
        <div class="smallrow">
          <span class="chip mono" id="lastUpdated">Last updated: —</span>
        </div>
      </div>

      <div class="two">
        <div>
          <h3 style="margin:10px 0 6px;">Counts by guide</h3>
          <div style="max-height:440px; overflow:auto; border-radius:14px;">
            <table id="summaryTable">
              <thead>
                <tr>
                  <th>Guide</th>
                  <th>Level</th>
                  <th class="right">Adult</th>
                  <th class="right">Youth</th>
                  <th class="right">Child</th>
                  <th class="right">Infant</th>
                  <th class="right">Total</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div>
          <h3 style="margin:10px 0 6px;">Cost by guide</h3>
          <div style="max-height:440px; overflow:auto; border-radius:14px;">
            <table id="costTable">
              <thead>
                <tr>
                  <th>Guide</th>
                  <th>Level</th>
                  <th class="right mono">Cost (€)</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th colspan="2" class="right">Grand total</th>
                  <th class="right mono" id="grandTotal">0.00</th>
                </tr>
              </tfoot>
            </table>
          </div>

          <details>
            <summary>1‑minute demo walkthrough (text)</summary>
            <div class="script-step"><strong>0–10s:</strong> “This demo shows automated check‑in for Eiffel Tower tours: routing, summaries, and cost.”</div>
            <div class="script-step"><strong>10–25s:</strong> “In Main Check‑In, I mark a guest as <em>Show</em> and assign a guide — automation triggers instantly.”</div>
            <div class="script-step"><strong>25–40s:</strong> “In Guide Sheets, the guest appears automatically — no copy/paste. De‑dup keeps entries clean.”</div>
            <div class="script-step"><strong>40–55s:</strong> “Now I switch Summit to <em>Closed</em>. Summit guests roll into Second Floor totals and costs update live.”</div>
            <div class="script-step"><strong>55–60s:</strong> “Outcome: a single source of truth for operations, even when conditions change during live check‑in.”</div>
          </details>
        </div>
      </div>
    </section>

    <section id="proof" class="card pad">
      <h2 style="margin:0 0 10px;">Proof notes (portfolio‑ready)</h2>
      <p class="note">
        This functional demo is designed to be used as evidence when original client sheets are not accessible.
        It reproduces the operational logic end‑to‑end using synthetic data only.
      </p>

      <div class="two">
        <div class="callout">
          <strong>What this proves</strong>
          <ul>
            <li>Runnable logic that reacts to user actions (event‑driven updates)</li>
            <li>Guide routing + de‑duplication safeguards</li>
            <li>Summit toggle reclassification (operational constraint handling)</li>
            <li>Ticket cost computation for purchasing decisions</li>
          </ul>
        </div>
        <div class="callout">
          <strong>How to present it</strong>
          <ul>
            <li>Record a 45–60s screen capture following the walkthrough text</li>
            <li>Include a screenshot of Main Check‑In + Summary tables</li>
            <li>Attach exported JSON as “demo evidence” (optional)</li>
            <li>State clearly: synthetic data, no client identifiers</li>
          </ul>
        </div>
      </div>

      <details>
        <summary>Key technical mapping (script → demo)</summary>
        <ul>
          <li><span class="mono">onEdit(e)</span> → form/table event handlers that recalc state</li>
          <li><span class="mono">LockService</span> → unnecessary for single-user demo; would map to DB transactions for multi-user</li>
          <li>De‑dup map → unique key = normalized guest name + guide</li>
          <li>Summit toggle → reclassify Summit counts into Second Floor when closed</li>
          <li>Ticket prices → lookup table applied to aggregated counts</li>
        </ul>
      </details>
    </section>

    <div class="footer">
      Built for portfolio demonstration. Data persists locally via <span class="mono">localStorage</span>.
      <div style="margin-top:8px;">© <span id="year"></span></div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
/** ---------------------------
 *  State & persistence
 *  --------------------------- */
const STORAGE_KEY = "et_checkin_demo_v1";

const GUIDES = ["Guide 1","Guide 2","Guide 3","Guide 4","Guide 5"];
const AGE_FIELDS = ["adult","youth","child","infant"];
const LEVELS = ["Summit","Second Floor"];

const defaultPrices = {
  Summit: { adult: 28.30, youth: 14.10, child: 7.10, infant: 0.00 },
  "Second Floor": { adult: 18.10, youth: 9.10, child: 4.60, infant: 0.00 },
};

let state = loadState();

function nowStamp(){
  const d = new Date();
  return d.toLocaleString();
}

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>{ el.style.display="none"; }, 2400);
}

function normalizeName(s){
  return (s || "").trim().toLowerCase().replace(/\\s+/g," ");
}

function calcTotal(row){
  return AGE_FIELDS.reduce((sum,k)=> sum + (Number(row[k])||0), 0);
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) throw new Error("no state");
    const parsed = JSON.parse(raw);
    return {
      summitStatus: parsed.summitStatus || "Summit Opened",
      prices: parsed.prices || defaultPrices,
      guests: Array.isArray(parsed.guests) ? parsed.guests : [],
      lastUpdated: parsed.lastUpdated || null
    };
  }catch(e){
    return {
      summitStatus: "Summit Opened",
      prices: structuredClone(defaultPrices),
      guests: [],
      lastUpdated: null
    };
  }
}

function saveState(){
  state.lastUpdated = new Date().toISOString();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderAll();
}

/** ---------------------------
 *  Demo data
 *  --------------------------- */
function seedSynthetic(){
  const seed = [
    { guestName:"Ama Mensah", status:"Show", level:"Summit", adult:2, youth:0, child:1, infant:0, guide:"Guide 1" },
    { guestName:"Kofi Boateng", status:"Show", level:"Second Floor", adult:1, youth:1, child:0, infant:0, guide:"Guide 2" },
    { guestName:"Sarah Dupont", status:"No Show", level:"Summit", adult:1, youth:0, child:0, infant:0, guide:"Guide 3" },
    { guestName:"Jean Martin", status:"Show", level:"Summit", adult:1, youth:0, child:0, infant:1, guide:"Guide 3" },
    { guestName:"Aisha Diallo", status:"Show", level:"Second Floor", adult:3, youth:0, child:0, infant:0, guide:"Guide 2" },
    { guestName:"Luca Rossi", status:"Show", level:"Summit", adult:2, youth:1, child:0, infant:0, guide:"Guide 4" },
    { guestName:"Nora Benali", status:"Show", level:"Second Floor", adult:1, youth:0, child:2, infant:0, guide:"Guide 5" },
    { guestName:"Kwame Asare", status:"Show", level:"Summit", adult:1, youth:0, child:1, infant:0, guide:"Guide 1" },
    { guestName:"Fatou Ndiaye", status:"Show", level:"Summit", adult:2, youth:0, child:0, infant:0, guide:"Guide 5" },
    { guestName:"Tom Müller", status:"Show", level:"Second Floor", adult:1, youth:0, child:0, infant:0, guide:"Guide 4" },
  ];

  // Apply dedup & totals
  seed.forEach(row => upsertGuest(row, {silent:true}));
  toast("Seeded synthetic data.");
  saveState();
}

/** ---------------------------
 *  Guest upsert (dedup key)
 *  --------------------------- */
function guestKey(row){
  return normalizeName(row.guestName) + "::" + (row.guide || "");
}

function upsertGuest(row, opts={silent:false}){
  const clean = {
    guestName: (row.guestName || "").trim(),
    status: row.status || "",
    level: LEVELS.includes(row.level) ? row.level : "Second Floor",
    adult: Number(row.adult)||0,
    youth: Number(row.youth)||0,
    child: Number(row.child)||0,
    infant: Number(row.infant)||0,
    guide: GUIDES.includes(row.guide) ? row.guide : "Guide 1",
  };
  clean.total = calcTotal(clean);
  clean.id = guestKey(clean);

  const idx = state.guests.findIndex(g => g.id === clean.id);
  if(idx >= 0){
    state.guests[idx] = clean;
    if(!opts.silent) toast("Updated guest (dedup key matched).");
  }else{
    state.guests.push(clean);
    if(!opts.silent) toast("Added guest.");
  }
  // Stable sort for readability
  state.guests.sort((a,b)=> (a.guide+b.guestName).localeCompare(b.guide+b.guestName));
}

function deleteGuest(id){
  state.guests = state.guests.filter(g => g.id !== id);
  toast("Deleted guest.");
  saveState();
}

function setFormFromGuest(g){
  document.getElementById("guestName").value = g.guestName;
  document.getElementById("status").value = g.status;
  document.getElementById("guide").value = g.guide;
  document.getElementById("level").value = g.level;
  document.getElementById("adult").value = g.adult;
  document.getElementById("youth").value = g.youth;
  document.getElementById("child").value = g.child;
  document.getElementById("infant").value = g.infant;
  updateTotalPreview();
  toast("Loaded guest into form. Edit and click Add/Update.");
}

/** ---------------------------
 *  Aggregations
 *  --------------------------- */
function summitEffectiveLevel(level){
  if(state.summitStatus === "Summit Closed" && level === "Summit"){
    return "Second Floor";
  }
  return level;
}

function shownGuests(){
  return state.guests.filter(g => (g.status || "").trim().toLowerCase() === "show");
}

function aggregateByGuideLevel(){
  // guide -> level -> counts
  const out = {};
  GUIDES.forEach(guide => {
    out[guide] = {};
    LEVELS.forEach(level => {
      out[guide][level] = { adult:0, youth:0, child:0, infant:0, total:0 };
    });
  });

  for(const g of shownGuests()){
    const lvl = summitEffectiveLevel(g.level);
    const bucket = out[g.guide][lvl];
    AGE_FIELDS.forEach(k => bucket[k] += Number(g[k])||0);
    bucket.total += Number(g.total)||0;
  }

  return out;
}

function costForCounts(level, counts){
  const p = state.prices[level];
  return (
    (counts.adult||0) * (p.adult||0) +
    (counts.youth||0) * (p.youth||0) +
    (counts.child||0) * (p.child||0) +
    (counts.infant||0) * (p.infant||0)
  );
}

/** ---------------------------
 *  Rendering
 *  --------------------------- */
let activeGuide = "Guide 1";

function renderAll(){
  renderControls();
  renderMainTable();
  renderGuideTabs();
  renderGuideView();
  renderSummaryTables();
  document.getElementById("year").textContent = new Date().getFullYear();
}

function renderControls(){
  const summitSel = document.getElementById("summitStatus");
  summitSel.value = state.summitStatus;

  const chip = document.getElementById("stateChip");
  chip.textContent = "State: " + state.summitStatus;
  chip.className = "chip " + (state.summitStatus === "Summit Closed" ? "warn" : "ok");

  // Prices fields
  const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = Number(v).toFixed(2); };
  setVal("p_summit_adult", state.prices.Summit.adult);
  setVal("p_summit_youth", state.prices.Summit.youth);
  setVal("p_summit_child", state.prices.Summit.child);
  setVal("p_summit_infant", state.prices.Summit.infant);
  setVal("p_second_adult", state.prices["Second Floor"].adult);
  setVal("p_second_youth", state.prices["Second Floor"].youth);
  setVal("p_second_child", state.prices["Second Floor"].child);
  setVal("p_second_infant", state.prices["Second Floor"].infant);

  // Last updated
  const lu = document.getElementById("lastUpdated");
  lu.textContent = "Last updated: " + (state.lastUpdated ? new Date(state.lastUpdated).toLocaleString() : "—");
}

function renderMainTable(){
  const tbody = document.querySelector("#mainTable tbody");
  tbody.innerHTML = "";

  if(state.guests.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="10" class="muted">No guests yet. Click “Seed synthetic data” to populate, or add a guest above.</td>`;
    tbody.appendChild(tr);
    return;
  }

  for(const g of state.guests){
    const statusChip = (normalizeName(g.status) === "show")
      ? `<span class="chip ok">Show</span>`
      : (g.status ? `<span class="chip bad">${escapeHtml(g.status)}</span>` : `<span class="chip warn">—</span>`);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="mono">${escapeHtml(g.guestName)}</span></td>
      <td>${statusChip}</td>
      <td>${escapeHtml(g.level)}</td>
      <td class="right mono">${g.adult}</td>
      <td class="right mono">${g.youth}</td>
      <td class="right mono">${g.child}</td>
      <td class="right mono">${g.infant}</td>
      <td class="right mono"><strong>${g.total}</strong></td>
      <td>${escapeHtml(g.guide)}</td>
      <td class="right">
        <button class="btn" data-action="edit" data-id="${g.id}">Edit</button>
        <button class="btn danger" data-action="del" data-id="${g.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // action handlers (event-driven)
  tbody.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if(action === "edit"){
        const g = state.guests.find(x => x.id === id);
        if(g) setFormFromGuest(g);
      }else if(action === "del"){
        if(confirm("Delete this guest record?")){
          deleteGuest(id);
        }
      }
    });
  });
}

function renderGuideTabs(){
  const tabs = document.getElementById("guideTabs");
  tabs.innerHTML = "";
  GUIDES.forEach(guide => {
    const el = document.createElement("div");
    el.className = "tab" + (guide === activeGuide ? " active" : "");
    const count = shownGuests().filter(g => g.guide === guide).length;
    el.textContent = `${guide} (${count})`;
    el.addEventListener("click", () => {
      activeGuide = guide;
      renderGuideTabs();
      renderGuideView();
    });
    tabs.appendChild(el);
  });
}

function renderGuideView(){
  const wrap = document.getElementById("guideView");
  const guests = shownGuests().filter(g => g.guide === activeGuide);

  if(guests.length === 0){
    wrap.innerHTML = `<div class="muted">No “Show” guests assigned to ${escapeHtml(activeGuide)} yet.</div>`;
    return;
  }

  const rows = guests.map(g => `
    <tr>
      <td class="mono">${escapeHtml(g.guestName)}</td>
      <td>${escapeHtml(g.level)}</td>
      <td class="right mono">${g.adult}</td>
      <td class="right mono">${g.youth}</td>
      <td class="right mono">${g.child}</td>
      <td class="right mono">${g.infant}</td>
      <td class="right mono"><strong>${g.total}</strong></td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <div class="smallrow" style="margin: 6px 0 10px;">
      <span class="chip ok">Show</span>
      <span class="chip mono">Active: ${escapeHtml(activeGuide)}</span>
      <span class="chip mono">Summit: ${escapeHtml(state.summitStatus)}</span>
    </div>

    <div style="max-height:420px; overflow:auto; border-radius:14px;">
      <table>
        <thead>
          <tr>
            <th>Guest</th>
            <th>ET Level</th>
            <th class="right">Adult</th>
            <th class="right">Youth</th>
            <th class="right">Child</th>
            <th class="right">Infant</th>
            <th class="right">Total</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function renderSummaryTables(){
  const agg = aggregateByGuideLevel();

  // Summary counts table
  const sbody = document.querySelector("#summaryTable tbody");
  sbody.innerHTML = "";
  let any = false;

  GUIDES.forEach(guide => {
    LEVELS.forEach(level => {
      const c = agg[guide][level];
      if(c.total > 0){
        any = true;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(guide)}</td>
          <td>${escapeHtml(level)}</td>
          <td class="right mono">${c.adult}</td>
          <td class="right mono">${c.youth}</td>
          <td class="right mono">${c.child}</td>
          <td class="right mono">${c.infant}</td>
          <td class="right mono"><strong>${c.total}</strong></td>
        `;
        sbody.appendChild(tr);
      }
    });
  });

  if(!any){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted">No “Show” guests yet. Add guests or seed data to populate summary.</td>`;
    sbody.appendChild(tr);
  }

  // Cost table
  const cbody = document.querySelector("#costTable tbody");
  cbody.innerHTML = "";
  let grand = 0;

  GUIDES.forEach(guide => {
    LEVELS.forEach(level => {
      const c = agg[guide][level];
      if(c.total > 0){
        const cost = costForCounts(level, c);
        grand += cost;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(guide)}</td>
          <td>${escapeHtml(level)}</td>
          <td class="right mono">${cost.toFixed(2)}</td>
        `;
        cbody.appendChild(tr);
      }
    });
  });

  if(grand === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="3" class="muted">No costs to display yet.</td>`;
    cbody.appendChild(tr);
  }

  document.getElementById("grandTotal").textContent = grand.toFixed(2);
}

/** ---------------------------
 *  Form helpers
 *  --------------------------- */
function updateTotalPreview(){
  const row = {
    adult: Number(document.getElementById("adult").value)||0,
    youth: Number(document.getElementById("youth").value)||0,
    child: Number(document.getElementById("child").value)||0,
    infant: Number(document.getElementById("infant").value)||0,
  };
  document.getElementById("total").value = calcTotal(row);
}

function readFormRow(){
  const row = {
    guestName: document.getElementById("guestName").value,
    status: document.getElementById("status").value,
    guide: document.getElementById("guide").value,
    level: document.getElementById("level").value,
    adult: Number(document.getElementById("adult").value)||0,
    youth: Number(document.getElementById("youth").value)||0,
    child: Number(document.getElementById("child").value)||0,
    infant: Number(document.getElementById("infant").value)||0,
  };
  return row;
}

function clearForm(){
  document.getElementById("guestName").value = "";
  document.getElementById("status").value = "";
  document.getElementById("level").value = "Summit";
  document.getElementById("adult").value = 1;
  document.getElementById("youth").value = 0;
  document.getElementById("child").value = 0;
  document.getElementById("infant").value = 0;
  document.getElementById("guide").value = "Guide 1";
  updateTotalPreview();
}

/** ---------------------------
 *  Export / import
 *  --------------------------- */
function exportJson(){
  const payload = {
    exportedAt: new Date().toISOString(),
    summitStatus: state.summitStatus,
    prices: state.prices,
    guests: state.guests,
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "et_checkin_demo_export.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("Exported JSON.");
}

function importJsonPrompt(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.addEventListener("change", async () => {
    const file = input.files[0];
    if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(!data || !Array.isArray(data.guests)) throw new Error("bad format");
      state.summitStatus = data.summitStatus || "Summit Opened";
      state.prices = data.prices || structuredClone(defaultPrices);
      state.guests = data.guests.map(g => ({
        guestName: (g.guestName||"").trim(),
        status: g.status || "",
        level: LEVELS.includes(g.level) ? g.level : "Second Floor",
        adult: Number(g.adult)||0,
        youth: Number(g.youth)||0,
        child: Number(g.child)||0,
        infant: Number(g.infant)||0,
        guide: GUIDES.includes(g.guide) ? g.guide : "Guide 1",
        total: Number(g.total)||0,
        id: g.id || guestKey(g)
      }));
      // Recompute ids & totals for safety
      state.guests.forEach(g => { g.total = calcTotal(g); g.id = guestKey(g); });
      toast("Imported JSON.");
      saveState();
    }catch(e){
      console.error(e);
      alert("Could not import. Please use an export from this demo.");
    }
  });
  input.click();
}

/** ---------------------------
 *  Utilities
 *  --------------------------- */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ---------------------------
 *  Wire up UI
 *  --------------------------- */
function init(){
  // Guides dropdown
  const guideSel = document.getElementById("guide");
  guideSel.innerHTML = GUIDES.map(g => `<option value="${g}">${g}</option>`).join("");

  // total preview listeners
  ["adult","youth","child","infant"].forEach(id => {
    document.getElementById(id).addEventListener("input", updateTotalPreview);
  });
  updateTotalPreview();

  // summit status
  document.getElementById("summitStatus").addEventListener("change", (e) => {
    state.summitStatus = e.target.value;
    toast("Summit status updated.");
    saveState();
  });

  // add / update
  document.getElementById("addBtn").addEventListener("click", () => {
    const row = readFormRow();
    if(!row.guestName || !row.guestName.trim()){
      alert("Please enter a guest name.");
      return;
    }
    upsertGuest(row);
    clearForm();
    saveState();
  });

  // seed / reset
  document.getElementById("seedBtn").addEventListener("click", () => {
    seedSynthetic();
  });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if(confirm("Reset demo data? This clears localStorage for this demo.")){
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      activeGuide = "Guide 1";
      clearForm();
      renderAll();
      toast("Reset complete.");
    }
  });

  // export / import
  document.getElementById("exportBtn").addEventListener("click", exportJson);
  document.getElementById("importBtn").addEventListener("click", importJsonPrompt);

  // prices
  document.getElementById("savePricesBtn").addEventListener("click", () => {
    const read = (id) => Number(document.getElementById(id).value)||0;
    state.prices = {
      Summit: {
        adult: read("p_summit_adult"),
        youth: read("p_summit_youth"),
        child: read("p_summit_child"),
        infant: read("p_summit_infant"),
      },
      "Second Floor": {
        adult: read("p_second_adult"),
        youth: read("p_second_youth"),
        child: read("p_second_child"),
        infant: read("p_second_infant"),
      }
    };
    toast("Prices saved.");
    saveState();
  });

  renderAll();
}

init();
</script>
</body>
</html>
